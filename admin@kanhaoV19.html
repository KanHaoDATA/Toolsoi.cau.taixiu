<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Quản lý Mã Kích Hoạt</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .card {
      background: #111;
      border: 2px solid #00ff00;
      padding: 20px;
      border-radius: 10px;
      max-width: 700px;
      margin: auto;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: black;
      border: 1px solid #00ff00;
      color: #00ff00;
      border-radius: 5px;
    }
    h2, h3 {
      text-align: center;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #222;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      margin-top: 5px;
      cursor: pointer;
    }
    input.inline {
      width: 100px;
      display: inline-block;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>Admin - Quản lý Mã Kích Hoạt</h2>

  <h3>Tạo mã kích hoạt mới</h3>
  <input type="text" id="email" placeholder="Nhập ID Tele">
  <input type="text" id="key" placeholder="Nhập mã kích hoạt (hoặc để trống để tự sinh)">
  <label for="expiryDate">Ngày hết hạn:</label>
  <input type="date" id="expiryDate">
  <input type="number" id="usesLeft" placeholder="Số lượt sử dụng (ví dụ: 100)">
  <button onclick="createKey()">Tạo mã kích hoạt</button>

  <h3>Danh sách ID Tele yêu cầu kích hoạt</h3>
  <ul id="pendingList"></ul>

  <h3>Danh sách mã kích hoạt đã tạo</h3>
  <ul id="keyList" class="key-list"></ul>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBMGLXd9HKgKWp4k34TEAKbYGvxfbD9cUo",
    authDomain: "kanhaodata.firebaseapp.com",
    databaseURL: "https://kanhaodata-default-rtdb.firebaseio.com",
    projectId: "kanhaodata",
    storageBucket: "kanhaodata.appspot.com",
    messagingSenderId: "820084045633",
    appId: "1:820084045633:web:8a1e6072a3125b146253c0"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  function loadPendingUsers() {
    const list = document.getElementById("pendingList");
    list.innerHTML = "";
    database.ref("pendingUsers").once("value", snapshot => {
      snapshot.forEach(child => {
        const emailKey = child.key;
        const email = emailKey;
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${email}</strong>
          <button class="btn-small" onclick="removePending('${emailKey}')">Xoá</button>
        `;
        list.appendChild(li);
      });
    });
  }

  function removePending(emailKey) {
    if (confirm("Xoá ID Tele này?")) {
      database.ref("pendingUsers/" + emailKey).remove().then(() => {
        alert("Đã xoá.");
        loadPendingUsers();
      });
    }
  }

  function generateKey() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let result = "";
    for (let i = 0; i < 16; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  function createKey() {
    const email = document.getElementById("email").value.trim();
    let key = document.getElementById("key").value.trim();
    const expiryDate = document.getElementById("expiryDate").value;
    const uses = parseInt(document.getElementById("usesLeft").value);

    if (!email || !expiryDate || !uses) {
      alert("Vui lòng nhập đầy đủ!");
      return;
    }

    if (!key) key = generateKey();

    database.ref("accessKeys/" + key).set({
      email: email,
      expiresAt: new Date(expiryDate).toISOString(),
      usesLeft: uses
    }).then(() => {
      alert("Tạo mã kích hoạt thành công!");
      localStorage.removeItem("adminForm");

      document.getElementById("email").value = "";
      document.getElementById("key").value = "";
      document.getElementById("expiryDate").value = "";
      document.getElementById("usesLeft").value = "";

      loadKeyList();
    }).catch(err => {
      alert("Lỗi tạo mã: " + err.message);
    });
  }

  function loadKeyList() {
    const keyList = document.getElementById("keyList");
    keyList.innerHTML = "";
    database.ref("accessKeys").once("value", snapshot => {
      snapshot.forEach(child => {
        const key = child.key;
        const data = child.val();
        const expires = new Date(data.expiresAt).toLocaleDateString();
        const li = document.createElement("li");

        li.innerHTML = `
          <strong>Mã:</strong> ${key}<br>
          <strong>ID Tele:</strong> ${data.email}<br>
          <strong>Hạn:</strong> ${expires}<br>
          <strong>Lượt còn lại:</strong> <span id="uses_${key}">${data.usesLeft}</span><br>
          <input type="number" class="inline" id="add_${key}" placeholder="Cộng lượt">
          <button class="btn-small" onclick="addUses('${key}')">Cộng</button>
          <input type="number" class="inline" id="sub_${key}" placeholder="Trừ lượt">
          <button class="btn-small" onclick="subtractUses('${key}')">Trừ</button>
          <button class="btn-small" onclick="removeKey('${key}')">Xoá</button>
        `;
        keyList.appendChild(li);
      });
    });
  }

  function addUses(key) {
    const input = document.getElementById(`add_${key}`);
    const addValue = parseInt(input.value);
    if (isNaN(addValue)) return alert("Vui lòng nhập số lượt hợp lệ");

    const usesText = document.getElementById(`uses_${key}`);
    const currentUses = parseInt(usesText.innerText);
    const newUses = currentUses + addValue;

    database.ref("accessKeys/" + key + "/usesLeft").set(newUses).then(() => {
      usesText.innerText = newUses;
      alert("Đã cập nhật lượt sử dụng.");
      input.value = "";
    });
  }

  function subtractUses(key) {
    const input = document.getElementById(`sub_${key}`);
    const subValue = parseInt(input.value);
    if (isNaN(subValue) || subValue <= 0) return alert("Vui lòng nhập số lượt hợp lệ");

    const usesText = document.getElementById(`uses_${key}`);
    const currentUses = parseInt(usesText.innerText);
    const newUses = currentUses - subValue;

    if (newUses < 0) return alert("Lượt sử dụng không thể âm!");

    database.ref("accessKeys/" + key + "/usesLeft").set(newUses).then(() => {
      usesText.innerText = newUses;
      alert("Đã trừ lượt sử dụng.");
      input.value = "";
    });
  }

  function removeKey(key) {
    if (confirm("Xoá mã kích hoạt này?")) {
      database.ref("accessKeys/" + key).remove().then(() => {
        alert("Đã xoá mã.");
        loadKeyList();
      });
    }
  }

  ["email", "key", "expiryDate", "usesLeft"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => {
      const form = {
        email: document.getElementById("email").value,
        key: document.getElementById("key").value,
        expiryDate: document.getElementById("expiryDate").value,
        usesLeft: document.getElementById("usesLeft").value
      };
      localStorage.setItem("adminForm", JSON.stringify(form));
    });
  });

  window.onload = function () {
    loadPendingUsers();
    loadKeyList();
    const saved = localStorage.getItem("adminForm");
    if (saved) {
      const form = JSON.parse(saved);
      document.getElementById("email").value = form.email || "";
      document.getElementById("key").value = form.key || "";
      document.getElementById("expiryDate").value = form.expiryDate || "";
      document.getElementById("usesLeft").value = form.usesLeft || "";
    }
  };
</script>

</body>
</html>
